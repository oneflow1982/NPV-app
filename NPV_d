import numpy as np
import streamlit as st
import matplotlib.pyplot as plt
from scipy.special import lambertw


# =========================================================
# –ú–û–î–ï–õ–¨ IRR (–ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ê–Ø, –ê–ù–ê–õ–û–ì WOLFRAM ProductLog)
# =========================================================
def IRR(
    Mvn,        # —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –†–í–î, —Ä—É–±
    Tvosst,     # –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞ –†–í–î, —á–∞—Å
    Msod,       # –≥–æ–¥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã, —Ä—É–±/–≥–æ–¥
    Cp,         # —á–∞—Å–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è —Ç–µ—Ö–Ω–∏–∫–∏, —Ä—É–±
    Kteh,       # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–µ–º–æ–π —Ç–µ—Ö–Ω–∏–∫–∏, –µ–¥.
    Ktg,        # –∑–∞–∫–ª–∞–¥—ã–≤–∞–µ–º—ã–π –ö–¢–ì –∏–∑-–∑–∞ –†–í–î (–¥–æ–ª—è)
    Tpl,        # –ø–ª–∞–Ω–æ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ –≥–æ–¥, —á–∞—Å
    Tvosstso,   # –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã, —á–∞—Å
    Y           # –≤—Ä–µ–º—è —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞, –ª–µ—Ç
):
    A = (
        Msod * Tvosst
        - Cp * Kteh * Ktg * Tpl * Tvosst
        + Cp * Kteh * Ktg * Tpl * Tvosstso
    )

    W = lambertw(
        (A * Y / (Mvn * Tvosst)) * np.exp((A * Y) / (Mvn * Tvosst))
    )

    irr = (
        -Msod * Tvosst * Y
        + Cp * Kteh * Ktg * Tpl * Tvosst * Y
        - Cp * Kteh * Ktg * Tpl * Tvosstso * Y
        + Mvn * Tvosst * W.real
    ) / (Mvn * Tvosst * Y)

    return irr


# =========================================================
# –ù–ê–°–¢–†–û–ô–ö–ò –°–¢–†–ê–ù–ò–¶–´
# =========================================================
st.set_page_config(
    page_title="IRR –ø—Ä–æ–µ–∫—Ç–∞ (–†–í–î)",
    layout="wide"
)

st.title("–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—á—ë—Ç IRR –ø—Ä–æ–µ–∫—Ç–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –†–í–î")


# =========================================================
# –ë–ê–ó–û–í–´–ô –°–¶–ï–ù–ê–†–ò–ô
# =========================================================
BASE = {
    "Mvn": 20_000_000,
    "Tvosstso": 2.0,
    "Kteh": 100,
    "Tpl": 5_000,
    "Tvosst": 12.0,
    "Msod": 1_000_000,
    "Cp": 50_000,
    "Ktg": 0.10
}

for key, value in BASE.items():
    if key not in st.session_state:
        st.session
        st.session_state[key] = value


# =========================================================
# SIDEBAR ‚Äî –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¶–ï–ù–ê–†–ò–ï–ú
# =========================================================
st.sidebar.header("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–º")

if st.sidebar.button("üîÑ –°–±—Ä–æ—Å –∫ –±–∞–∑–æ–≤–æ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é"):
    for key, value in BASE.items():
        st.session_state[key] = value


# =========================================================
# SIDEBAR ‚Äî –ü–ê–†–ê–ú–ï–¢–†–´ (–í–°–ï ‚Äî –ü–û–õ–Ø –í–í–û–î–ê)
# =========================================================
st.sidebar.markdown("### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞")

Mvn = st.sidebar.number_input(
    "–°—Ç–æ–∏–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –†–í–î, —Ä—É–± (Mvn)",
    min_value=1_000_000,
    max_value=1_000_000_000,
    step=1_000_000,
    key="Mvn"
)

Tvosstso = st.sidebar.number_input(
    "–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã, —á–∞—Å (Tvosstso)",
    min_value=0.5,
    max_value=24.0,
    step=0.5,
    key="Tvosstso"
)

Kteh = st.sidebar.number_input(
    "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Ö–Ω–∏–∫–∏, –µ–¥. (Kteh)",
    min_value=1,
    max_value=10_000,
    step=1,
    key="Kteh"
)

Tpl = st.sidebar.number_input(
    "–ü–ª–∞–Ω–æ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ –≥–æ–¥, —á–∞—Å (Tpl)",
    min_value=1,
    max_value=8_760,
    step=10,
    key="Tpl"
)

Tvosst = st.sidebar.number_input(
    "–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞ –†–í–î, —á–∞—Å (Tvosst)",
    min_value=0.1,
    max_value=168.0,
    step=0.5,
    key="Tvosst"
)

Msod = st.sidebar.number_input(
    "–≠–∫—Å–ø–ª. –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã, —Ä—É–±/–≥–æ–¥ (Msod)",
    min_value=0,
    max_value=50_000_000,
    step=100_000,
    key="Msod"
)

Cp = st.sidebar.number_input(
    "–ß–∞—Å–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è —Ç–µ—Ö–Ω–∏–∫–∏, —Ä—É–± (Cp)",
    min_value=0,
    max_value=5_000_000,
    step=1_000,
    key="Cp"
)

Ktg = st.sidebar.number_input(
    "–ó–∞–∫–ª–∞–¥—ã–≤–∞–µ–º—ã–π –ö–¢–ì –∏–∑-–∑–∞ –†–í–î (–¥–æ–ª—è, ‚â§ 1)",
    min_value=0.0,
    max_value=1.0,
    step=0.01,
    key="Ktg"
)


# =========================================================
# –†–ê–°–ß–Å–¢
# =========================================================
Y = np.linspace(0.1, 4, 300)   # –≥–æ—Ä–∏–∑–æ–Ω—Ç —Ä–∞—Å—á—ë—Ç–∞ ‚Äî 4 –≥–æ–¥–∞

irr = IRR(
    Mvn=Mvn,
    Tvosst=Tvosst,
    Msod=Msod,
    Cp=Cp,
    Kteh=Kteh,
    Ktg=Ktg,
    Tpl=Tpl,
    Tvosstso=Tvosstso,
    Y=Y
)

irr_2 = np.interp(2, Y, irr) * 100
irr_4 = np.interp(4, Y, irr) * 100


# =========================================================
# KPI
# =========================================================
col1, col2, col3 = st.columns(3)

col1.metric("IRR –Ω–∞ 2-–º –≥–æ–¥—É", f"{irr_2:.2f} %")
col2.metric("IRR –Ω–∞ 4-–º –≥–æ–¥—É", f"{irr_4:.2f} %")
col3.metric("–ö–∞–ø–≤–ª–æ–∂–µ–Ω–∏—è", f"{Mvn/1_000_000:.1f} –º–ª–Ω —Ä—É–±")


# =========================================================
# –ì–†–ê–§–ò–ö
# =========================================================
fig, ax = plt.subplots()
ax.plot(Y, irr * 100)
ax.set_xlabel("–í—Ä–µ–º—è, –ª–µ—Ç")
ax.set_ylabel("IRR, %")
ax.set_title("IRR –ø—Ä–æ–µ–∫—Ç–∞ (–≥–æ—Ä–∏–∑–æ–Ω—Ç —Ä–∞—Å—á—ë—Ç–∞ ‚Äî 4 –≥–æ–¥–∞)")
ax.grid(True)

st.pyplot(fig)


# =========================================================
# –û–ü–ò–°–ê–ù–ò–ï –°–¶–ï–ù–ê–†–ò–Ø
# =========================================================
st.markdown("### –û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è")

st.write(
    f"""
**–°—Ç–æ–∏–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –†–í–î:** {Mvn:,.0f} —Ä—É–±  
**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Ö–Ω–∏–∫–∏:** {Kteh} –µ–¥.  
**–ü–ª–∞–Ω–æ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:** {Tpl} —á–∞—Å/–≥–æ–¥  
**–ß–∞—Å–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è:** {Cp:,.0f} —Ä—É–±  
**–≠–∫—Å–ø–ª. –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:** {Msod:,.0f} —Ä—É–±/–≥–æ–¥  
**–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞ –†–í–î:** {Tvosst} —á–∞—Å  
**–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã:** {Tvosstso} —á–∞—Å  
**–ó–∞–∫–ª–∞–¥—ã–≤–∞–µ–º—ã–π –ö–¢–ì –∏–∑-–∑–∞ –†–í–î:** {Ktg:.2f}  

–ü—Ä–∏ –∑–∞–¥–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö **IRR –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ 4 –ª–µ—Ç —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç {irr_4:.2f}%**.
"""
)
