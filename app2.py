import numpy as np
import streamlit as st
import matplotlib.pyplot as plt
from scipy.special import lambertw


# =========================================================
# –ú–û–î–ï–õ–¨ IRR (–ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ê–Ø, –ê–ù–ê–õ–û–ì WOLFRAM ProductLog)
# =========================================================
def IRR(
    Mvn,        # —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –†–í–î, —Ä—É–±
    Tvosst,     # –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞ –†–í–î, —á–∞—Å
    Msod,       # –≥–æ–¥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã, —Ä—É–±/–≥–æ–¥
    Cp,         # —á–∞—Å–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è —Ç–µ—Ö–Ω–∏–∫–∏, —Ä—É–±
    Kteh,       # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–µ–º–æ–π —Ç–µ—Ö–Ω–∏–∫–∏, –µ–¥.
    Ktg,        # –∑–∞–∫–ª–∞–¥—ã–≤–∞–µ–º—ã–π –ö–¢–ì –∏–∑-–∑–∞ –†–í–î (–¥–æ–ª—è)
    Tpl,        # –ø–ª–∞–Ω–æ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ –≥–æ–¥, —á–∞—Å
    Tvosstso,   # –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã, —á–∞—Å
    Y           # –≤—Ä–µ–º—è —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞, –ª–µ—Ç
):
    A = (
        Msod * Tvosst
        - Cp * Kteh * Ktg * Tpl * Tvosst
        + Cp * Kteh * Ktg * Tpl * Tvosstso
    )

    W = lambertw(
        (A * Y / (Mvn * Tvosst)) * np.exp((A * Y) / (Mvn * Tvosst))
    )

    irr = (
        -Msod * Tvosst * Y
        + Cp * Kteh * Ktg * Tpl * Tvosst * Y
        - Cp * Kteh * Ktg * Tpl * Tvosstso * Y
        + Mvn * Tvosst * W.real
    ) / (Mvn * Tvosst * Y)

    return irr


# =========================================================
# –ú–û–î–ï–õ–¨ NPV (–ß–ò–°–¢–ê–Ø –ü–†–ò–í–ï–î–ï–ù–ù–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨)
# =========================================================
def NPV(
    Mvn,        # —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –†–í–î, —Ä—É–±
    Tvosst,     # –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞ –†–í–î, —á–∞—Å
    Msod,       # –≥–æ–¥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã, —Ä—É–±/–≥–æ–¥
    Cp,         # —á–∞—Å–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è —Ç–µ—Ö–Ω–∏–∫–∏, —Ä—É–±
    Kteh,       # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Å–ª—É–∂–∏–≤–∞–µ–º–æ–π —Ç–µ—Ö–Ω–∏–∫–∏, –µ–¥.
    Ktg,        # –∑–∞–∫–ª–∞–¥—ã–≤–∞–µ–º—ã–π –ö–¢–ì –∏–∑-–∑–∞ –†–í–î (–¥–æ–ª—è)
    Tpl,        # –ø–ª–∞–Ω–æ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ –≥–æ–¥, —á–∞—Å
    Tvosstso,   # –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã, —á–∞—Å
    Y,          # –≤—Ä–µ–º—è —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–æ–µ–∫—Ç–∞, –ª–µ—Ç
    r           # —Å—Ç–∞–≤–∫–∞ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –¥–æ–ª–∏
):
    """
    –†–∞—Å—á–µ—Ç NPV –ø–æ —Ñ–æ—Ä–º—É–ª–µ:
    NPV = -Mvn + Œ£[CF_t / (1+r)^t]
    –≥–¥–µ CF_t = –≠–∫–æ–Ω–æ–º–∏—è –≤ –≥–æ–¥—É t - –≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã
    
    –≠–∫–æ–Ω–æ–º–∏—è –≤ –≥–æ–¥ –æ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å—Ç–æ—è:
    –≠–∫–æ–Ω–æ–º–∏—è = Cp * Kteh * (Tpl * Ktg / Tvosst) * (Tvosst - Tvosstso)
    """
    # –†–∞—Å—á–µ—Ç –≥–æ–¥–æ–≤–æ–≥–æ –¥–µ–Ω–µ–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫–∞–∑–æ–≤ –≤ –≥–æ–¥ = (Tpl * Ktg) / Tvosst
    # –≠–∫–æ–Ω–æ–º–∏—è –Ω–∞ –æ–¥–Ω–æ–º –æ—Ç–∫–∞–∑–µ = Cp * (Tvosst - Tvosstso)
    godovaya_ekonomiya = Cp * Kteh * (Tpl * Ktg / Tvosst) * (Tvosst - Tvosstso)
    
    # –ì–æ–¥–æ–≤–æ–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫ (—ç–∫–æ–Ω–æ–º–∏—è –º–∏–Ω—É—Å —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã)
    godovoy_potok = godovaya_ekonomiya - Msod
    
    # –†–∞—Å—á–µ—Ç NPV –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥–æ–¥–∞ Y
    # –î–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    npv_values = -Mvn + godovoy_potok * (1 - np.exp(-r * Y)) / r
    
    return npv_values


# =========================================================
# –ù–ê–°–¢–†–û–ô–ö–ò –°–¢–†–ê–ù–ò–¶–´
# =========================================================
st.set_page_config(
    page_title="IRR –∏ NPV –ø—Ä–æ–µ–∫—Ç–∞ (–†–í–î)",
    layout="wide"
)

st.title("–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—á—ë—Ç IRR –∏ NPV –ø—Ä–æ–µ–∫—Ç–∞ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –†–í–î")


# =========================================================
# –ë–ê–ó–û–í–´–ô –°–¶–ï–ù–ê–†–ò–ô
# =========================================================
BASE = {
    "Mvn": 20_000_000,
    "Tvosstso": 2.0,
    "Kteh": 100,
    "Tpl": 5_000,
    "Tvosst": 12.0,
    "Msod": 1_000_000,
    "Cp": 50_000,
    "Ktg": 0.10,
    "r": 0.15  # –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç–∞–≤–∫–∞ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
}

for key, value in BASE.items():
    if key not in st.session_state:
        st.session_state[key] = value


# =========================================================
# SIDEBAR ‚Äî –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–¶–ï–ù–ê–†–ò–ï–ú
# =========================================================
st.sidebar.header("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–º")

if st.sidebar.button("üîÑ –°–±—Ä–æ—Å –∫ –±–∞–∑–æ–≤–æ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é"):
    for key, value in BASE.items():
        st.session_state[key] = value


# =========================================================
# SIDEBAR ‚Äî –ü–ê–†–ê–ú–ï–¢–†–´ (–í–°–ï ‚Äî –ü–û–õ–Ø –í–í–û–î–ê)
# =========================================================
st.sidebar.markdown("### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞")

Mvn = st.sidebar.number_input(
    "–°—Ç–æ–∏–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –†–í–î, —Ä—É–± (Mvn)",
    min_value=1,
    max_value=1_000_000_000,
    step=1,
    key="Mvn"
)

Tvosstso = st.sidebar.number_input(
    "–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã, —á–∞—Å (Tvosstso)",
    min_value=0.5,
    max_value=24.0,
    step=0.5,
    key="Tvosstso"
)

Kteh = st.sidebar.number_input(
    "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Ö–Ω–∏–∫–∏, –µ–¥. (Kteh)",
    min_value=1,
    max_value=10_000,
    step=1,
    key="Kteh"
)

Tpl = st.sidebar.number_input(
    "–ü–ª–∞–Ω–æ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤ –≥–æ–¥, —á–∞—Å (Tpl)",
    min_value=1,
    max_value=8_760,
    step=10,
    key="Tpl"
)

Tvosst = st.sidebar.number_input(
    "–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–∞ –†–í–î, —á–∞—Å (Tvosst)",
    min_value=0.1,
    max_value=168.0,
    step=0.5,
    key="Tvosst"
)

Msod = st.sidebar.number_input(
    "–≠–∫—Å–ø–ª. –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã, —Ä—É–±/–≥–æ–¥ (Msod)",
    min_value=0,
    max_value=500_000_000,
    step=1_000,
    key="Msod"
)

Cp = st.sidebar.number_input(
    "–ß–∞—Å–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è —Ç–µ—Ö–Ω–∏–∫–∏, —Ä—É–± (Cp)",
    min_value=0,
    max_value=5_000_000,
    step=1_000,
    key="Cp"
)

Ktg = st.sidebar.number_input(
    "–ó–∞–∫–ª–∞–¥—ã–≤–∞–µ–º—ã–π –ö–¢–ì –∏–∑-–∑–∞ –†–í–î (–¥–æ–ª—è, ‚â§ 1)",
    min_value=0.0,
    max_value=1.0,
    step=0.01,
    key="Ktg"
)

r = st.sidebar.number_input(
    "–°—Ç–∞–≤–∫–∞ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–æ–ª—è, ‚â§ 1)",
    min_value=0.0,
    max_value=1.0,
    step=0.01,
    value=0.15,
    key="r"
)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –≤–≤–æ–¥–∞
if Tvosstso >= Tvosst:
    st.sidebar.warning("‚ö†Ô∏è –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ú–ï–ù–¨–®–ï –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ —Å–∏—Å—Ç–µ–º—ã!")
    
if r <= 0:
    st.sidebar.error("‚ùå –°—Ç–∞–≤–∫–∞ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π!")


# =========================================================
# –†–ê–°–ß–Å–¢
# =========================================================
# –ò–∑–º–µ–Ω—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω Y –æ—Ç 0 –¥–æ 4 –ª–µ—Ç
Y = np.linspace(0, 4, 400)   # –≥–æ—Ä–∏–∑–æ–Ω—Ç —Ä–∞—Å—á—ë—Ç–∞ –æ—Ç 0 –¥–æ 4 –ª–µ—Ç

# –î–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤ –∏—Å–∫–ª—é—á–∞–µ–º Y=0, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å –≤ —Ñ—É–Ω–∫—Ü–∏–∏ IRR
Y_calc = Y[Y > 0]

# –†–∞—Å—á–µ—Ç IRR (—Ç–æ–ª—å–∫–æ –¥–ª—è Y > 0)
irr_calc = IRR(
    Mvn=Mvn,
    Tvosst=Tvosst,
    Msod=Msod,
    Cp=Cp,
    Kteh=Kteh,
    Ktg=Ktg,
    Tpl=Tpl,
    Tvosstso=Tvosstso,
    Y=Y_calc
)

# –†–∞—Å—á–µ—Ç NPV (–¥–ª—è –≤—Å–µ—Ö Y, –≤–∫–ª—é—á–∞—è 0)
npv = NPV(
    Mvn=Mvn,
    Tvosst=Tvosst,
    Msod=Msod,
    Cp=Cp,
    Kteh=Kteh,
    Ktg=Ktg,
    Tpl=Tpl,
    Tvosstso=Tvosstso,
    Y=Y,
    r=r
)

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—ã–π –º–∞—Å—Å–∏–≤ IRR —Å NaN –¥–ª—è Y=0
irr = np.full_like(Y, np.nan)
irr[Y > 0] = irr_calc

# –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ 2-–º –∏ 4-–º –≥–æ–¥—É
irr_2 = np.interp(2, Y_calc, irr_calc) * 100 if len(Y_calc) > 0 else 0
irr_4 = np.interp(4, Y_calc, irr_calc) * 100 if len(Y_calc) > 0 else 0
npv_2 = np.interp(2, Y, npv)
npv_4 = np.interp(4, Y, npv)


# =========================================================
# KPI
# =========================================================
st.markdown("### –ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏")

col1, col2, col3, col4 = st.columns(4)

col1.metric(
    "IRR –Ω–∞ 2-–º –≥–æ–¥—É", 
    f"{irr_2:.1f} %",
    delta=f"{(irr_2 - r*100):+.1f}% vs r" if irr_2 > 0 else None,
    delta_color="normal"
)

col2.metric(
    "IRR –Ω–∞ 4-–º –≥–æ–¥—É", 
    f"{irr_4:.1f} %",
    delta=f"{(irr_4 - r*100):+.1f}% vs r" if irr_4 > 0 else None,
    delta_color="normal"
)

col3.metric(
    "NPV –Ω–∞ 2-–º –≥–æ–¥—É", 
    f"{npv_2:,.0f} —Ä—É–±",
    delta="–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π" if npv_2 > 0 else "–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π",
    delta_color="normal"
)

col4.metric(
    "NPV –Ω–∞ 4-–º –≥–æ–¥—É", 
    f"{npv_4:,.0f} —Ä—É–±",
    delta=f"{npv_4/1_000_000:.1f} –º–ª–Ω —Ä—É–±",
    delta_color="normal"
)

# –ê–Ω–∞–ª–∏–∑ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
st.markdown("### –ê–Ω–∞–ª–∏–∑ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏")

if irr_4 > r * 100 and npv_4 > 0:
    st.success(f"‚úÖ **–ü—Ä–æ–µ–∫—Ç –ü–†–ò–í–õ–ï–ö–ê–¢–ï–õ–ï–ù:** IRR ({irr_4:.1f}%) > r ({r*100:.1f}%) –∏ NPV ({npv_4:,.0f} —Ä—É–±) > 0")
elif irr_4 > r * 100 and npv_4 <= 0:
    st.warning(f"‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞:** IRR ({irr_4:.1f}%) > r ({r*100:.1f}%), –Ω–æ NPV ({npv_4:,.0f} —Ä—É–±) ‚â§ 0")
elif irr_4 <= r * 100 and npv_4 > 0:
    st.warning(f"‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞:** IRR ({irr_4:.1f}%) ‚â§ r ({r*100:.1f}%), –Ω–æ NPV ({npv_4:,.0f} —Ä—É–±) > 0")
else:
    st.error(f"‚ùå **–ü—Ä–æ–µ–∫—Ç –ù–ï–ü–†–ò–í–õ–ï–ö–ê–¢–ï–õ–ï–ù:** IRR ({irr_4:.1f}%) ‚â§ r ({r*100:.1f}%) –∏ NPV ({npv_4:,.0f} —Ä—É–±) ‚â§ 0")


# =========================================================
# –ì–†–ê–§–ò–ö–ò
# =========================================================
st.markdown("### –ì—Ä–∞—Ñ–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–µ–∫—Ç–∞")

# –°–æ–∑–¥–∞–µ–º –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
col_graph1, col_graph2 = st.columns(2)

# –ì—Ä–∞—Ñ–∏–∫ IRR
with col_graph1:
    fig1, ax1 = plt.subplots(figsize=(10, 6))
    
    # –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ IRR (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º Y=0, –≥–¥–µ –∑–Ω–∞—á–µ–Ω–∏–µ NaN)
    mask = ~np.isnan(irr)
    ax1.plot(Y[mask], irr[mask] * 100, label='IRR', color='blue', linewidth=2)
    
    # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è —Å—Ç–∞–≤–∫–∏ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    ax1.axhline(y=r*100, color='red', linestyle='--', 
                label=f'–°—Ç–∞–≤–∫–∞ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ({r*100:.1f}%)')
    
    # –ó–∞–∫—Ä–∞—à–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç–∏
    if np.any(mask):
        Y_masked = Y[mask]
        irr_masked = irr[mask] * 100
        
        # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å, –≥–¥–µ IRR —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–æ–ª—å—à–µ r
        idx_above = irr_masked > r*100
        idx_below = irr_masked <= r*100
        
        if np.any(idx_above):
            ax1.fill_between(Y_masked[idx_above], irr_masked[idx_above], r*100, 
                           color='green', alpha=0.3, label='IRR > r')
        
        if np.any(idx_below):
            ax1.fill_between(Y_masked[idx_below], irr_masked[idx_below], r*100, 
                           color='red', alpha=0.3, label='IRR ‚â§ r')
    
    # –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ –¥–ª—è 2 –∏ 4 –ª–µ—Ç
    ax1.axvline(x=2, color='gray', linestyle=':', alpha=0.5)
    ax1.axvline(x=4, color='gray', linestyle=':', alpha=0.5)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
    ax1.set_xlim(0, 4)  # –û—Å—å X –æ—Ç 0 –¥–æ 4 –ª–µ—Ç
    ax1.set_xlabel("–í—Ä–µ–º—è, –ª–µ—Ç")
    ax1.set_ylabel("IRR, %")
    ax1.set_title("–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –Ω–æ—Ä–º–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (IRR)")
    ax1.grid(True, alpha=0.3)
    ax1.legend()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
    if irr_2 > 0:
        ax1.annotate(f'{irr_2:.1f}%', xy=(2, irr_2), xytext=(2.1, irr_2+5),
                    arrowprops=dict(arrowstyle='->', color='blue'))
    
    if irr_4 > 0:
        ax1.annotate(f'{irr_4:.1f}%', xy=(4, irr_4), xytext=(3.7, irr_4+5),
                    arrowprops=dict(arrowstyle='->', color='blue'))
    
    st.pyplot(fig1)

# –ì—Ä–∞—Ñ–∏–∫ NPV
with col_graph2:
    fig2, ax2 = plt.subplots(figsize=(10, 6))
    
    # –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫ NPV (–≤ –º–ª–Ω —Ä—É–±)
    ax2.plot(Y, npv / 1_000_000, label='NPV', color='green', linewidth=2)
    
    # –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è –Ω—É–ª—è
    ax2.axhline(y=0, color='black', linestyle='-', alpha=0.5)
    
    # –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ –¥–ª—è 2 –∏ 4 –ª–µ—Ç
    ax2.axvline(x=2, color='gray', linestyle=':', alpha=0.5)
    ax2.axvline(x=4, color='gray', linestyle=':', alpha=0.5)
    
    # –ó–∞–∫—Ä–∞—à–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç–∏ –≤—ã—à–µ –∏ –Ω–∏–∂–µ –Ω—É–ª—è
    ax2.fill_between(Y, npv/1_000_000, 0, where=(npv/1_000_000 > 0), 
                     color='green', alpha=0.3, label='NPV > 0')
    ax2.fill_between(Y, npv/1_000_000, 0, where=(npv/1_000_000 <= 0), 
                     color='red', alpha=0.3, label='NPV ‚â§ 0')
    
    # –¢–æ—á–∫–∞ –ø—Ä–∏ Y=0 (–Ω–∞—á–∞–ª—å–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏)
    ax2.scatter(0, -Mvn/1_000_000, color='red', s=100, zorder=5, 
                label=f'–ö–∞–ø–≤–ª–æ–∂–µ–Ω–∏—è: {-Mvn/1_000_000:.1f} –º–ª–Ω —Ä—É–±')
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
    ax2.set_xlim(0, 4)  # –û—Å—å X –æ—Ç 0 –¥–æ 4 –ª–µ—Ç
    ax2.set_ylim(min(-Mvn/1_000_000 - 5, npv.min()/1_000_000 - 5), 
                 max(0, npv.max()/1_000_000 + 5))
    ax2.set_xlabel("–í—Ä–µ–º—è, –ª–µ—Ç")
    ax2.set_ylabel("NPV, –º–ª–Ω —Ä—É–±")
    ax2.set_title("–ß–∏—Å—Ç–∞—è –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (NPV)")
    ax2.grid(True, alpha=0.3)
    ax2.legend()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏
    ax2.annotate(f'{npv_2/1_000_000:.1f} –º–ª–Ω', xy=(2, npv_2/1_000_000), 
                 xytext=(2.1, npv_2/1_000_000 + (npv_4/1_000_000 - npv_2/1_000_000)/4),
                 arrowprops=dict(arrowstyle='->', color='green'))
    
    ax2.annotate(f'{npv_4/1_000_000:.1f} –º–ª–Ω', xy=(4, npv_4/1_000_000), 
                 xytext=(3.7, npv_4/1_000_000 + (npv_4/1_000_000 - npv_2/1_000_000)/4),
                 arrowprops=dict(arrowstyle='->', color='green'))
    
    st.pyplot(fig2)


# =========================================================
# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ê–°–ß–ï–¢–´
# =========================================================
st.markdown("### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã")

# –†–∞—Å—á–µ—Ç —Å—Ä–æ–∫–∞ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏
if npv[-1] > 0:  # –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –≤ —Ü–µ–ª–æ–º –æ–∫—É–ø–∞–µ—Ç—Å—è
    # –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫—É, –≥–¥–µ NPV —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
    positive_npv_indices = np.where(npv > 0)[0]
    if len(positive_npv_indices) > 0:
        payback_period = Y[positive_npv_indices[0]]
        st.info(f"**–°—Ä–æ–∫ –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏:** {payback_period:.1f} –ª–µ—Ç")

# –†–∞—Å—á–µ—Ç —Ç–æ—á–∫–∏ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
if r > 0 and Tvosst > 0 and Cp > 0 and Kteh > 0 and Ktg > 0 and Tpl > 0:
    # –†–µ—à–∞–µ–º —É—Ä–∞–≤–Ω–µ–Ω–∏–µ NPV = 0 –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ Tvosstso –ø—Ä–∏ Y=4
    Y_target = 4
    Tvosstso_break_even = Tvosst - (Msod + Mvn * r / (1 - np.exp(-r * Y_target))) * Tvosst / (Cp * Kteh * Ktg * Tpl)
    
    if 0 < Tvosstso_break_even < Tvosst:
        st.info(f"**–¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–∑–∞ 4 –≥–æ–¥–∞):** {Tvosstso_break_even:.1f} —á–∞—Å–æ–≤")
        improvement_percent = (Tvosst - Tvosstso_break_even) / Tvosst * 100
        st.write(f"–î–ª—è –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞ 4 –≥–æ–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–∫—Ä–∞—â–∞—Ç—å –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –º–∏–Ω–∏–º—É–º –Ω–∞ {improvement_percent:.1f}% (—Å {Tvosst} –¥–æ {Tvosstso_break_even:.1f} —á–∞—Å–æ–≤)")


# =========================================================
# –û–ü–ò–°–ê–ù–ò–ï –°–¶–ï–ù–ê–†–ò–Ø
# =========================================================
st.markdown("### –û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è")

# –†–∞—Å—á–µ—Ç –¥–µ–Ω–µ–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
if Tvosst > 0:
    godovaya_ekonomiya = Cp * Kteh * (Tpl * Ktg / Tvosst) * (Tvosst - Tvosstso)
    godovoy_potok = godovaya_ekonomiya - Msod
else:
    godovaya_ekonomiya = 0
    godovoy_potok = 0

st.write(
    f"""
**–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞:**
- **–°—Ç–æ–∏–º–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã:** {Mvn:,.0f} —Ä—É–±
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Ö–Ω–∏–∫–∏:** {Kteh} –µ–¥.
- **–ü–ª–∞–Ω–æ–≤–æ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:** {Tpl} —á–∞—Å/–≥–æ–¥
- **–ß–∞—Å–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ—è:** {Cp:,.0f} —Ä—É–±
- **–≠–∫—Å–ø–ª. –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:** {Msod:,.0f} —Ä—É–±/–≥–æ–¥
- **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–±–µ–∑ —Å–∏—Å—Ç–µ–º—ã):** {Tvosst} —á–∞—Å
- **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (—Å —Å–∏—Å—Ç–µ–º–æ–π):** {Tvosstso} —á–∞—Å
- **–ó–∞–∫–ª–∞–¥—ã–≤–∞–µ–º—ã–π –ö–¢–ì –∏–∑-–∑–∞ –†–í–î:** {Ktg:.2f}
- **–°—Ç–∞–≤–∫–∞ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** {r:.2f} ({r*100:.1f}%)

**–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:**
- **–ì–æ–¥–æ–≤–∞—è —ç–∫–æ–Ω–æ–º–∏—è –æ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ–µ–≤:** {godovaya_ekonomiya:,.0f} —Ä—É–±/–≥–æ–¥
- **–ì–æ–¥–æ–≤–æ–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫:** {godovoy_potok:,.0f} —Ä—É–±/–≥–æ–¥
- **IRR –ø—Ä–æ–µ–∫—Ç–∞ (4 –≥–æ–¥–∞):** {irr_4:.1f}%
- **NPV –ø—Ä–æ–µ–∫—Ç–∞ (4 –≥–æ–¥–∞):** {npv_4:,.0f} —Ä—É–± ({npv_4/1_000_000:.1f} –º–ª–Ω —Ä—É–±)

**–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
- –ü—Ä–æ–µ–∫—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º –ø—Ä–∏ **IRR > r** –∏ **NPV > 0**
- –¢–µ–∫—É—â–∏–π IRR ({irr_4:.1f}%) {'>' if irr_4 > r*100 else '‚â§'} —Ç—Ä–µ–±—É–µ–º–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ ({r*100:.1f}%)
- NPV –ø—Ä–æ–µ–∫—Ç–∞ –∑–∞ 4 –≥–æ–¥–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç **{npv_4/1_000_000:.1f} –º–ª–Ω —Ä—É–±**
- –ü—Ä–æ–µ–∫—Ç {'–æ–∫—É–ø–∞–µ—Ç—Å—è' if npv_4 > 0 else '–Ω–µ –æ–∫—É–ø–∞–µ—Ç—Å—è'} –∑–∞ 4 –≥–æ–¥–∞
"""
)


# =========================================================
# –°–û–í–ú–ï–°–¢–ù–´–ô –ì–†–ê–§–ò–ö (–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û)
# =========================================================
with st.expander("üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–≤–º–µ—â–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ IRR –∏ NPV"):
    fig3, ax3 = plt.subplots(figsize=(12, 8))
    
    # –î–≤–µ –æ—Å–∏ Y
    ax3_irr = ax3
    ax3_npv = ax3_irr.twinx()
    
    # –ì—Ä–∞—Ñ–∏–∫ IRR
    mask = ~np.isnan(irr)
    line1 = ax3_irr.plot(Y[mask], irr[mask] * 100, label='IRR', color='blue', linewidth=2)
    ax3_irr.axhline(y=r*100, color='blue', linestyle='--', alpha=0.5, label=f'–°—Ç–∞–≤–∫–∞ r ({r*100:.1f}%)')
    
    # –ì—Ä–∞—Ñ–∏–∫ NPV
    line2 = ax3_npv.plot(Y, npv / 1_000_000, label='NPV', color='green', linewidth=2)
    ax3_npv.axhline(y=0, color='green', linestyle='--', alpha=0.5, label='NPV = 0')
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å–µ–π
    ax3_irr.set_xlim(0, 4)
    ax3_irr.set_xlabel("–í—Ä–µ–º—è, –ª–µ—Ç")
    ax3_irr.set_ylabel("IRR, %", color='blue')
    ax3_irr.tick_params(axis='y', labelcolor='blue')
    
    ax3_npv.set_ylabel("NPV, –º–ª–Ω —Ä—É–±", color='green')
    ax3_npv.tick_params(axis='y', labelcolor='green')
    
    # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ª–µ–≥–µ–Ω–¥
    lines = line1 + line2
    labels = [l.get_label() for l in lines]
    ax3_irr.legend(lines, labels, loc='upper left')
    
    ax3.set_title("–°–æ–≤–º–µ—â–µ–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ IRR –∏ NPV –ø—Ä–æ–µ–∫—Ç–∞ (0-4 –≥–æ–¥–∞)")
    ax3.grid(True, alpha=0.3)
    
    st.pyplot(fig3)


# =========================================================
# –í–´–í–û–î –§–û–†–ú–£–õ
# =========================================================
with st.expander("üìê –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–æ–≤"):
    st.markdown("""
    ### –§–æ—Ä–º—É–ª—ã —Ä–∞—Å—á–µ—Ç–∞

    **1. –ì–æ–¥–æ–≤–∞—è —ç–∫–æ–Ω–æ–º–∏—è –æ—Ç —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å—Ç–æ—è:**
    ```
    –≠–∫–æ–Ω–æ–º–∏—è = Cp √ó Kteh √ó (Tpl √ó Ktg / Tvosst) √ó (Tvosst - Tvosstso)
    ```

    **2. –ì–æ–¥–æ–≤–æ–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫ (CF):**
    ```
    CF = –≠–∫–æ–Ω–æ–º–∏—è - Msod
    ```

    **3. –ß–∏—Å—Ç–∞—è –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (NPV):**
    ```
    NPV = -Mvn + CF √ó (1 - exp(-r √ó Y)) / r
    ```
    *–≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –¥–∏—Å–∫–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ*

    **4. –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –Ω–æ—Ä–º–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (IRR):**
    ```
    IRR –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ W-—Ñ—É–Ω–∫—Ü–∏—é –õ–∞–º–±–µ—Ä—Ç–∞
    –∏–∑ —É—Ä–∞–≤–Ω–µ–Ω–∏—è NPV(IRR) = 0
    ```

    **5. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è:**
    - –ü—Ä–æ–µ–∫—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è, –µ—Å–ª–∏: **IRR > r** –∏ **NPV > 0**
    - –ü—Ä–æ–µ–∫—Ç –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏: **IRR < r** –∏–ª–∏ **NPV < 0**
    """)
